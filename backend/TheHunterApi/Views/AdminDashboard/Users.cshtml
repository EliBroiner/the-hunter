@model List<TheHunterApi.Data.AppManagedUser>
@{
    ViewData["Title"] = "ניהול משתמשים";
    var isSuccess = TempData["UsersMessageSuccess"] as bool? ?? true;
    var alertClass = isSuccess ? "alert-success" : "alert-warning";
}

@if (TempData["UsersMessage"] != null)
{
    <div class="alert @alertClass alert-dismissible fade show" role="alert">
        @TempData["UsersMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="סגור"></button>
    </div>
}

<h1 class="mb-4">@ViewData["Title"]</h1>

<section class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="card-title mb-0 h5">הוספת משתמש</h2>
    </div>
    <div class="card-body">
        <form asp-action="AddUser" asp-controller="AdminDashboard" method="post" class="row g-3">
            @Html.AntiForgeryToken()
            <div class="col-md-4">
                <label for="email" class="form-label">מייל</label>
                <input type="email" id="email" name="email" class="form-control" required placeholder="user@gmail.com" />
            </div>
            <div class="col-md-4">
                <label for="userId" class="form-label">Firebase UID (אופציונלי)</label>
                <input type="text" id="userId" name="userId" class="form-control" placeholder="ימולא בהתחברות ראשונה" />
            </div>
            <div class="col-md-3">
                <label for="role" class="form-label">תפקיד</label>
                <select id="role" name="role" class="form-select">
                    <option value="User">User</option>
                    <option value="DebugAccess">DebugAccess</option>
                    <option value="Admin">Admin</option>
                </select>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">הוסף</button>
            </div>
        </form>
        <p class="text-muted small mt-2 mb-0">Admin ו-DebugAccess יכולים לראות Debug Token. User — משתמש רגיל.</p>
    </div>
</section>

<section class="card">
    <div class="card-header">
        <h2 class="card-title mb-0 h5">רשימת משתמשים (@Model.Count)</h2>
    </div>
    <div class="card-body">
        @if (Model.Count == 0)
        {
            <p class="text-muted mb-0">לא נמצאו משתמשים — הוסף משתמש למעלה או הגדר INITIAL_ADMIN_EMAIL להפעלה ראשונה. אם נכנסת עם מפתח ב-URL, היכנס דרך /admin/login?key=מפתח_Admin כדי שהעגינה תשלח עם כל בקשה.</p>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>מייל</th>
                            <th>UserId</th>
                            <th>תפקיד</th>
                            <th>עודכן</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var u in Model)
                        {
                            <tr>
                                <td>@u.Email</td>
                                <td><code class="small">@(string.IsNullOrEmpty(u.UserId) ? "—" : u.UserId)</code></td>
                                <td>
                                    <form asp-action="UpdateUser" asp-controller="AdminDashboard" asp-route-id="@u.Id" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <select name="role" class="form-select form-select-sm" onchange="this.form.submit()">
                                            @if (u.Role == "User") { <option value="User" selected>User</option> } else { <option value="User">User</option> }
                                            @if (u.Role == "DebugAccess") { <option value="DebugAccess" selected>DebugAccess</option> } else { <option value="DebugAccess">DebugAccess</option> }
                                            @if (u.Role == "Admin") { <option value="Admin" selected>Admin</option> } else { <option value="Admin">Admin</option> }
                                        </select>
                                    </form>
                                </td>
                                <td class="small text-muted">@u.UpdatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                <td>
                                    <form asp-action="DeleteUser" asp-controller="AdminDashboard" asp-route-id="@u.Id" method="post" class="d-inline"
                                          onsubmit="return confirm('למחוק את @u.Email?');">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-outline-danger btn-sm">מחק</button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</section>
